quarkus.application.name=opensearch-manager
quarkus.application.version=@version@

# Container image configuration
quarkus.container-image.registry=ghcr.io
quarkus.container-image.group=ai-pipestream
quarkus.container-image.name=opensearch-manager
quarkus.container-image.tag=latest

# Jandex indexing for third-party and internal dynamic gRPC libraries
quarkus.index-dependency.apicurio-registry.group-id=io.apicurio
quarkus.index-dependency.apicurio-registry.artifact-id=apicurio-registry-protobuf-serde-kafka
quarkus.index-dependency.grpc-stubs.group-id=ai.pipestream
quarkus.index-dependency.grpc-stubs.artifact-id=grpc-stubs
quarkus.index-dependency.dynamic-grpc.group-id=ai.pipestream
quarkus.index-dependency.dynamic-grpc.artifact-id=dynamic-grpc

# Production port allocation
quarkus.http.port=38103
quarkus.http.host=0.0.0.0
quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-health-service=true

# Development overrides
%dev.quarkus.http.port=38103
%dev.quarkus.http.root-path=/opensearch-manager

# Compose Dev Services - Use shared dev services via extension
%dev.quarkus.compose.devservices.enabled=true
%dev.quarkus.compose.devservices.files=${user.home}/.pipeline/compose-devservices.yml
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.devservices.timeout=120s

# Disable standalone devservices since we're using Compose Dev Services
%dev.quarkus.datasource.devservices.enabled=false

# Service Registration Configuration
service.registration.enabled=true
service.registration.service-name=opensearch-manager
service.registration.description=OpenSearch indexing and search management service
service.registration.service-type=APPLICATION
service.registration.host=${OPENSEARCH_MANAGER_HOST:host.docker.internal}
service.registration.port=${quarkus.http.port}
%dev.quarkus.consul.grpc.health.enabled=true
service.registration.capabilities=opensearch-indexing,search-management,kafka-consumer
service.registration.tags=opensearch,indexing,search,kafka-consumer

# Stork Consul Self-Registration
quarkus.stork.opensearch-manager.service-registrar.type=consul
quarkus.stork.opensearch-manager.service-registrar.consul-host=${CONSUL_HOST:consul}
quarkus.stork.opensearch-manager.service-registrar.consul-port=${CONSUL_PORT:8500}
%dev.quarkus.stork.opensearch-manager.service-registrar.consul-host=localhost

# Dynamic gRPC Service Discovery
quarkus.consul.host=${CONSUL_HOST:localhost}
quarkus.consul.port=${CONSUL_PORT:8500}

# gRPC Channel Caching Configuration
quarkus.cache.caffeine."grpc-channels".expire-after-write=10m
quarkus.cache.caffeine."grpc-channels".maximum-size=100
quarkus.cache.caffeine."grpc-channels-mutiny".expire-after-write=10m
quarkus.cache.caffeine."grpc-channels-mutiny".maximum-size=100

# gRPC Service Registration
service.registration.grpc.enabled=true
service.registration.grpc.port=${quarkus.grpc.server.port:${quarkus.http.port}}
quarkus.grpc.server.enable-reflection-service=true

# Health checks
quarkus.smallrye-health.root-path=/q/health
quarkus.smallrye-health.liveness-path=/q/health/live
quarkus.smallrye-health.readiness-path=/q/health/ready

# Logging Configuration
quarkus.log.level=INFO
quarkus.log.category."ai.pipestream".level=INFO
quarkus.log.category."io.vertx.ext.consul".level=WARN
%dev.quarkus.log.console.level=INFO
%dev.quarkus.log.category."io.quarkus.grpc".level=WARN
%dev.quarkus.log.category."io.smallrye.stork".level=WARN

# OpenSearch Configuration
opensearch.hosts=${OPENSEARCH_HOST:localhost}:${OPENSEARCH_PORT:9200}
opensearch.protocol=http
opensearch.username=${OPENSEARCH_USERNAME:}
opensearch.password=${OPENSEARCH_PASSWORD:}

# Schema manager specific configuration
schema.manager.lock.timeout=PT10S

# Kafka Configuration
kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}
kafka.group.id=opensearch-manager
kafka.auto.offset.reset=earliest
kafka.enable.auto.commit=false

# Apicurio Registry configuration
mp.messaging.connector.smallrye-kafka.apicurio.registry.url=${APICURIO_REGISTRY_URL:http://localhost:8081/apis/registry/v3}

# Kafka Consumers
mp.messaging.incoming.drive-updates-in.connector=smallrye-kafka
mp.messaging.incoming.drive-updates-in.topic=drive-updates
mp.messaging.incoming.drive-updates-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
mp.messaging.incoming.drive-updates-in.apicurio.registry.serde.find-latest=true
mp.messaging.incoming.drive-updates-in.apicurio.registry.deserializer.value.return-class=ai.pipestream.repository.filesystem.DriveUpdateNotification

mp.messaging.incoming.repository-document-events-in.connector=smallrye-kafka
mp.messaging.incoming.repository-document-events-in.topic=repository-events
mp.messaging.incoming.repository-document-events-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
mp.messaging.incoming.repository-document-events-in.apicurio.registry.serde.find-latest=true
mp.messaging.incoming.repository-document-events-in.apicurio.registry.deserializer.value.return-class=ai.pipestream.repository.filesystem.RepositoryEvent

mp.messaging.incoming.module-updates-in.connector=smallrye-kafka
mp.messaging.incoming.module-updates-in.topic=module-updates
mp.messaging.incoming.module-updates-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
mp.messaging.incoming.module-updates-in.apicurio.registry.serde.find-latest=true
mp.messaging.incoming.module-updates-in.apicurio.registry.deserializer.value.return-class=ai.pipestream.repository.v1.ModuleUpdateNotification

mp.messaging.incoming.pipedoc-updates-in.connector=smallrye-kafka
mp.messaging.incoming.pipedoc-updates-in.topic=pipedoc-updates
mp.messaging.incoming.pipedoc-updates-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
mp.messaging.incoming.pipedoc-updates-in.apicurio.registry.serde.find-latest=true
mp.messaging.incoming.pipedoc-updates-in.apicurio.registry.deserializer.value.return-class=ai.pipestream.repository.v1.PipeDocUpdateNotification

mp.messaging.incoming.process-request-updates-in.connector=smallrye-kafka
mp.messaging.incoming.process-request-updates-in.topic=process-request-updates
mp.messaging.incoming.process-request-updates-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
mp.messaging.incoming.process-request-updates-in.apicurio.registry.serde.find-latest=true
mp.messaging.incoming.process-request-updates-in.apicurio.registry.deserializer.value.return-class=ai.pipestream.repository.v1.ProcessRequestUpdateNotification

mp.messaging.incoming.process-response-updates-in.connector=smallrye-kafka
mp.messaging.incoming.process-response-updates-in.topic=process-response-updates
mp.messaging.incoming.process-response-updates-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
mp.messaging.incoming.process-response-updates-in.apicurio.registry.serde.find-latest=true
mp.messaging.incoming.process-response-updates-in.apicurio.registry.deserializer.value.return-class=ai.pipestream.repository.v1.ProcessResponseUpdateNotification

mp.messaging.incoming.graph-updates-in.connector=smallrye-kafka
mp.messaging.incoming.graph-updates-in.topic=graph-updates
mp.messaging.incoming.graph-updates-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
mp.messaging.incoming.graph-updates-in.apicurio.registry.serde.find-latest=true
mp.messaging.incoming.graph-updates-in.apicurio.registry.deserializer.value.return-class=ai.pipestream.config.v1.GraphUpdateNotification

# Test Profile Configuration
%test.quarkus.devservices.enabled=true
%test.quarkus.compose.devservices.files=src/test/resources/compose-test-services.yml
%test.quarkus.compose.devservices.start-services=true
%test.quarkus.compose.devservices.project-name=pipeline-test-services
%test.quarkus.compose.devservices.stop-services=false
%test.quarkus.compose.devservices.reuse-project-for-tests=true
%test.quarkus.compose.devservices.stop-timeout=30s

# Disable individual devservices (compose provides everything)
%test.quarkus.datasource.devservices.enabled=false
%test.quarkus.kafka.devservices.enabled=false

# Test Kafka and Apicurio config
%test.kafka.bootstrap.servers=${TEST_KAFKA_HOST:localhost}:${TEST_KAFKA_PORT:9095}
%test.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${TEST_KAFKA_HOST:localhost}:${TEST_KAFKA_PORT:9095}
%test.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://${TEST_APICURIO_HOST:localhost}:${TEST_APICURIO_PORT:8082}/apis/registry/v3

# OpenSearch test configuration
%test.opensearch.hosts=${TEST_OPENSEARCH_HOST:localhost}:${TEST_OPENSEARCH_PORT:9201}

# Test HTTP configuration
%test.quarkus.http.test-port=0

# Disable service registration in tests
%test.service.registration.enabled=false

# Wiremock for gRPC registration service
%test.quarkus.wiremock.devservices.enabled=true
%test.quarkus.wiremock.devservices.extension-scanning-enabled=true
%test.quarkus.wiremock.devservices.files-mapping=classpath:META-INF
%test.quarkus.wiremock.devservices.global-response-templating=true
